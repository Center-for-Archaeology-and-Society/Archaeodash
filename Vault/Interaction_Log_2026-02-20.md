# Interaction Log 2026-02-20

- User reported persistent Shiny render error in Visualize & Assign (UMAP + Data Ellipse + group symbols); narrowed issue to Plotly compatibility in marker symbol handling, restricted symbols to a conservative cross-version set, added explicit render error surfacing in `visualizeAssignServer`, and validated with full test suite.
- User reported the same error persisted after patch; verified container state and found `archaeodashbeta` was updated/restarted with patched package while a separate `archaeodash` container remained on an older package version, indicating likely endpoint/version mismatch during verification.
- Pulled beta Shiny logs and identified concrete failure path in `output$pointLabelColumnUI` (`if: missing value where TRUE/FALSE needed` from NA selector state); hardened selector default resolution against NA/empty values, registered plotly selection event explicitly, re-tested, reinstalled package into `archaeodashbeta`, and restarted beta container.
- User reported beta server crash during multiplot action; identified invalid output wiring (`renderUI` returning render function objects), split multiplot into proper UI + dedicated plot renderers, added regression coverage for interactive/static multiplot return types, and redeployed only `archaeodashbeta`.
- User requested a multiplot loading indicator without deployment; added a modal loading indicator (`Building multiplot...`) around multiplot generation with safe teardown and retained code-only/local-test state (no install/restart).
- User reported save-plot dialog appearing after clicking multiplot update; fixed nested observer registration by moving `savePlot` observer out of `updateMultiplot` and setting `ignoreInit=TRUE`, then validated locally without deployment.
- User requested commit/tag/restart for beta fixes; prepared release commit with vault documentation updates, created a release tag, installed current source into `archaeodashbeta`, and restarted beta container.
- User reported multiplot loading indicator sometimes stays visible after plot renders; hardened cleanup logic by removing `req()` short-circuit exits in loader scope and enforcing `hide_multiplot_loading()` in a `tryCatch(..., finally=...)` block, then validated locally without deployment.
- User reported loading issue persisted and requested stricter multiplot guards plus commit/install/restart; added axis validation to block update without X or Y and block overlapping X/Y selections, added unit coverage, ran full tests, then prepared deployment to beta.
- User requested thorough security audit with external testing and recommendations only; performed black-box checks against the beta URL and code-level auth/cookie/DB review, then documented prioritized security recommendations without application code changes.
- User requested double-check and implementation of security recommendations with tests first; implemented token-based remembered login, login throttling, cookie/token hardening, credential-file cleanup, added unit + opt-in DB-backed shinytest2 temp-user/INAA e2e tests, ran full tests, and documented infra-only constraints for headers/banner controls.
- User requested Apache vhost review while keeping `.Renviron` unchanged; audited current `sites-available`/enabled config and provided hardening recommendations for headers, directory policy, proxy limits, and endpoint access control without changing server config.
- User requested commit/tag/install for `archaeodashbeta`; prepared release commit for security hardening updates, created timestamp release tag, installed package into beta container, and restarted beta only.
- User requested another external-only security audit (plus SQLi sanity check); executed black-box endpoint/header/method/path/SockJS probes against beta, verified SQL parameterization patterns in DB code, and delivered prioritized attack-vector recommendations without code changes.
- User reported upload append failure due to `bind_rows()` character-vs-numeric column mismatch; added pre-append type harmonization in `merge_loaded_data()` (numeric-like to numeric, otherwise character), added regression tests, then installed and committed to beta (no tag).
- User asked whether upload append type-mismatch failures are automatable; reviewed current unit and shinytest2 coverage, confirmed this class is testable via automation, and identified remaining e2e gap for two-upload append workflow assertions.
- User asked to close the upload-append automation gap; added a shinytest2 e2e test for two sequential uploads with intentional shared-column type mismatch and verified append success by table row growth (2 to 4), then validated test pass.
- User reported interactive multiplot hangs and requested cancel option; optimized interactive multiplot generation/conversion safeguards, added cancel control/state handling to multiplot loading modal, added regression tests, and prepared commit/tag/install for beta.
- Asked whether Heurist login timeout can be increased and users kept logged in; confirmed app already defaults to persistent login (30 days) and identified exact code points to extend token/cookie lifetime.
- Requested transformation metadata synchronization across saved transformations; implemented canonical metadata sync from `importedData`, added unfiltered snapshot base (`selectedDataAll`) plus per-snapshot group-filter derivation, updated load/persistence paths, and validated targeted transformation/data-input tests.
- Reported CSP report-only violations blocking Heurist external JS/CSS dependencies under strict `script-src/style-src`; provided targeted Apache CSP allowlist updates for required CDN hosts plus a safer migration path toward self-hosted assets and reduced `unsafe-*`.
- Reported `accessTokens.php` blocked by `X-Content-Type-Options: nosniff` with `text/html`; provided root-cause triage and fix guidance to return the correct MIME type (or correct the caller/resource type) instead of weakening `nosniff`.
- Requested Visualize & Assign layout/filter improvements; moved controls to a right-side sidebar, added metadata-field visualization filter with multi-select values (display-only via rowid intersection), hardened selection sync under filtering, and prepared commit/tag/install steps.
- Reported unspecified visualization-filter error; traced to `vizMetaFilterFieldUI` NA handling (`if: missing value where TRUE/FALSE needed`), hardened NA/empty guards for both metadata field/value UI renderers, reinstalled and restarted `archaeodashbeta`, and verified the error no longer appears in fresh logs.
- Requested release promotion to live; prepared release commit/tag in beta repo, synchronized current tree into `../Archaeodash`, installed package into `archaeodash` container, and restarted live service.
- Requested a responsive filter placement option in Visualize & Assign; replaced fixed layout with dynamic rendering that supports right-side or below-plot controls, added a `filters_below_plot` toggle, and defaulted to below-plot for mobile-width clients via one-time client-width detection.
- Reported beta instability after responsive layout release; identified a length-zero guard bug in mobile width detection (`output_plot_width`) causing `if: argument is of length zero`, patched guard logic, reinstalled/restarted `archaeodashbeta`, and verified clean logs for that error signature.
- Requested regression coverage + release actions; extracted mobile-default width logic into a pure helper (`resolve_filters_below_plot_default`), added targeted unit tests for empty/NA/non-numeric/threshold scenarios, reran tests, then prepared tag/commit/install on beta.
- Reported multi-dataset load hang; traced likely DB contention from background dataset-list refresh firing during active dataset loading, added load-state refresh gating + load re-entry guard + deferred `currentDatasetName` update until load completion, added helper regression assertions, and prepared beta redeploy.
- Reported multi-dataset hang persisted after refresh; fixed another loader-deadlock path where `show_dataset_loading()` could run before a `req` abort and leave the modal open indefinitely, replaced with explicit selection validation + guaranteed teardown via `on.exit`, and added normalization/test coverage.
- Reported save errors from overly long table names; added deterministic dataset-table name shortening with hash suffix and max-length enforcement for both upload and merge flows, surfaced user-facing notification when shortening occurs, and added regression tests.
- Reported multi-dataset loading still hanging; removed eager `mutate_all(as.character)` coercion during per-table `collect()` in workspace loader to reduce heavy memory/CPU blocking, and added stage-level load logging to isolate exactly where stalls occur in future runs.
- Asked whether server-wide resource pressure is causing hangs in both apps; checked host CPU/RAM/disk/load, container stats, MySQL process/lock status, and app logs, found no current DB/CPU/memory saturation but identified shared `bslib/sass` cache permission failures (`/srv/shiny-server/inst/app/app_cache`) across both apps as a likely repeated latency source.
- Approved cache fix; created writable sass cache directories in both beta/live app trees, set shared write permissions, restarted both containers, and verified fresh worker logs no longer emit `app_cache` permission warnings.
- Asked whether persistent live hangs after hard refresh require logout/relogin or dataset reset; diagnosed live-vs-beta revision drift (`archaeodash` at `df958d9` vs `Archaeodashbeta` at `1ee5157`) showing live lacks recent multi-dataset hang fixes, indicating issue persists on live code rather than user session state.
- Approved live promotion; synchronized beta tree into `../Archaeodash`, installed updated package in `archaeodash`, restarted live container, and verified HTTP health with no fresh `app_cache` permission warnings in post-restart logs.
- Requested multiplot UX fixes; hardened multiplot loading-modal teardown so it always closes on errors and added automatic X-to-Y exclusion for multiplot selectors (choosing X removes overlaps from Y), added regression tests, installed to `archaeodashbeta`, and restarted beta.
- Reported remaining live table-name length errors; diagnosed transformation persistence naming overflow (`prefix` 55 + `_selected_all` 13 > 64), implemented computed prefix cap based on max suffix length, added regression assertions for full table-name lengths, installed to live `archaeodash`, and restarted container.
- Requested stricter 32-char policy and full table update; implemented 32-char naming policy across dataset/prefs/transformation generators, added DB migration utilities and startup migration hook, deployed to live, executed migration (`151` renames + `5` orphan cleanup renames), and verified no dataset base or transformation tables remain over 32 chars.
- Reported continued hang on dataset confirm after hard refresh; identified likely regression from running full table-name migration scan at server startup per worker/session, changed migration to opt-in via `ARCHAEODASH_RUN_TABLE_MIGRATION=1` (disabled by default), redeployed live, and restarted `archaeodash`.

## Related

- [[Interaction_Log]]
- [[Visualize_Assign_UMAP_Symbol_Compatibility_Fix_2026-02-20]]
- [[Index]]
